<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/controller.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Display Controller</h1>
            <div class="status" id="connectionStatus">Disconnected</div>
        </header>

        <div class="controls">
            <div class="control-section">
                <h2>Quick Navigation</h2>
                <div class="button-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <a href="/setup" class="nav-link" style="text-decoration: none; display: block;">
                        <button class="control-btn" style="width: 100%;">
                            <div class="btn-icon">‚öôÔ∏è</div>
                            <div class="btn-title">Event Setup</div>
                            <div class="btn-desc">Configure event settings</div>
                        </button>
                    </a>
                    <a href="/display" class="nav-link" target="_blank" style="text-decoration: none; display: block;">
                        <button class="control-btn" style="width: 100%;">
                            <div class="btn-icon">üì∫</div>
                            <div class="btn-title">Open Display</div>
                            <div class="btn-desc">Audience display window</div>
                        </button>
                    </a>
                    <a href="/schedule" class="nav-link" target="_blank" style="text-decoration: none; display: block;">
                        <button class="control-btn" style="width: 100%;">
                            <div class="btn-icon">üìÖ</div>
                            <div class="btn-title">Match Schedule</div>
                            <div class="btn-desc">View game sessions</div>
                        </button>
                    </a>
                    <a href="/scores" class="nav-link" target="_blank" style="text-decoration: none; display: block;">
                        <button class="control-btn" style="width: 100%;">
                            <div class="btn-icon">üìä</div>
                            <div class="btn-title">Team Scores</div>
                            <div class="btn-desc">View all team scores</div>
                        </button>
                    </a>
                </div>
            </div>

            <div class="control-section">
                <h2>Current Event</h2>
                <div class="current-event" id="currentEvent">
                    Loading...
                </div>
            </div>

            <div class="control-section">
                <h2>Select Display Mode</h2>
                <p class="description">Choose what to show on the audience display</p>

                <div class="button-grid">
                    <button class="control-btn match-btn" data-screen="matchOverlay">
                        <div class="btn-icon">üéÆ</div>
                        <div class="btn-title">Game Mode</div>
                        <div class="btn-desc">Show match timer and team info</div>
                    </button>

                    <button class="control-btn rankings-btn" data-screen="rankingsOverlay">
                        <div class="btn-icon">üèÜ</div>
                        <div class="btn-title">Rankings</div>
                        <div class="btn-desc">Display current team rankings</div>
                    </button>

                    <button class="control-btn sponsors-btn" data-screen="sponsors">
                        <div class="btn-icon">üíº</div>
                        <div class="btn-title">Sponsors</div>
                        <div class="btn-desc">Show sponsor slideshow</div>
                    </button>

                    <button class="control-btn blank-btn" data-screen="blank">
                        <div class="btn-icon">‚¨õ</div>
                        <div class="btn-title">Blank Screen</div>
                        <div class="btn-desc">Hide all overlays</div>
                    </button>
                </div>
            </div>

            <div class="control-section">
                <h2>Current Display</h2>
                <div class="current-display" id="currentDisplay">
                    Match Overlay
                </div>
            </div>

            <div class="control-section">
                <h2>Match Timer Control</h2>
                <div class="timer-display" id="timerDisplay">2:30</div>
                <div class="timer-controls">
                    <button class="timer-btn start-btn" id="startTimer">
                        ‚ñ∂Ô∏è Start Match
                    </button>
                    <button class="timer-btn pause-btn" id="pauseTimer">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="timer-btn reset-btn" id="resetTimer">
                        üîÑ Reset
                    </button>
                </div>
                <div class="timer-info">
                    <small>Match Duration: 2 minutes 30 seconds</small>
                </div>
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        let currentScreen = 'matchOverlay';
        let timerInterval = null;
        let currentSeconds = 150; // 2:30
        let isTimerRunning = false;

        const screenNames = {
            'matchOverlay': 'Game Mode',
            'rankingsOverlay': 'Rankings',
            'sponsors': 'Sponsors',
            'blank': 'Blank Screen'
        };

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').classList.add('connected');

            // Request current event info on connect
            socket.emit('request_event_info');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').classList.remove('connected');
        });

        // Handle event info updates
        socket.on('event_info', (data) => {
            console.log('Received event info:', data);
            if (data.region && data.event_id) {
                // Update current event display
                const eventName = data.event_name || data.event_id;
                document.getElementById('currentEvent').textContent = `Current: ${data.region}/${eventName}`;
            }
        });

        // Handle overlay selection
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const screen = this.getAttribute('data-screen');

                // Remove active class from all buttons
                document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));

                // Add active class to clicked button
                this.classList.add('active');

                // Emit to server
                socket.emit('set_overlay', { screen: screen });

                // Update current display
                currentScreen = screen;
                document.getElementById('currentDisplay').textContent = screenNames[screen] || screen;
            });
        });

        // Handle overlay selection update from server
        socket.on('overlay_selection', (data) => {
            currentScreen = data.screen;
            document.getElementById('currentDisplay').textContent = screenNames[data.screen] || data.screen;

            // Update active button
            document.querySelectorAll('.control-btn').forEach(btn => {
                if (btn.getAttribute('data-screen') === data.screen) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        });

        // Timer functions
        function updateTimerDisplay() {
            const minutes = Math.floor(currentSeconds / 60);
            const secs = currentSeconds % 60;
            const timeString = `${minutes}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = timeString;
        }

        function startTimer() {
            if (isTimerRunning) return;

            isTimerRunning = true;
            document.getElementById('startTimer').disabled = true;
            document.getElementById('pauseTimer').disabled = false;

            timerInterval = setInterval(() => {
                if (currentSeconds > 0) {
                    currentSeconds--;
                    updateTimerDisplay();
                    // Broadcast to displays
                    socket.emit('timer_update', { seconds: currentSeconds });
                } else {
                    stopTimer();
                }
            }, 1000);
        }

        function stopTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startTimer').disabled = false;
            document.getElementById('pauseTimer').disabled = true;
        }

        function resetTimer() {
            stopTimer();
            currentSeconds = 150;
            updateTimerDisplay();
            socket.emit('timer_update', { seconds: currentSeconds });
        }

        // Timer controls
        document.getElementById('startTimer').addEventListener('click', startTimer);
        document.getElementById('pauseTimer').addEventListener('click', stopTimer);
        document.getElementById('resetTimer').addEventListener('click', resetTimer);

        // Set initial active button
        document.querySelector('[data-screen="matchOverlay"]').classList.add('active');
        document.getElementById('pauseTimer').disabled = true;
    </script>
</body>
</html>
