<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/controller.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Event Setup</h1>
            <div class="status" id="connectionStatus">Disconnected</div>
        </header>

        <div class="controls">
            <div class="control-section">
                <h2>Navigation</h2>
                <div class="button-grid">
                    <a href="/controller" class="nav-link">
                        <button class="control-btn">
                            <div class="btn-icon">ðŸŽ®</div>
                            <div class="btn-title">Controller</div>
                            <div class="btn-desc">Control displays and timer</div>
                        </button>
                    </a>
                    <a href="/display" class="nav-link" target="_blank">
                        <button class="control-btn">
                            <div class="btn-icon">ðŸ“º</div>
                            <div class="btn-title">Display</div>
                            <div class="btn-desc">Open audience display</div>
                        </button>
                    </a>
                    <a href="/schedule" class="nav-link" target="_blank">
                        <button class="control-btn">
                            <div class="btn-icon">ðŸ“…</div>
                            <div class="btn-title">Match Schedule</div>
                            <div class="btn-desc">View match schedule</div>
                        </button>
                    </a>
                    <a href="/scores" class="nav-link" target="_blank">
                        <button class="control-btn">
                            <div class="btn-icon">ðŸ“Š</div>
                            <div class="btn-title">Team Scores</div>
                            <div class="btn-desc">View team scores</div>
                        </button>
                    </a>
                </div>
            </div>

            <div class="control-section">
                <h2>Event Selection</h2>
                <p class="description">Select which FLL event to display rankings and information for</p>

                <div class="event-selector">
                    <div class="form-group">
                        <label for="regionSelect">Region:</label>
                        <input type="text" id="regionSelect" value="socal" placeholder="e.g., socal, norcal, socal2">
                    </div>
                    <div class="form-group">
                        <label for="eventSelect">Event:</label>
                        <select id="eventSelect">
                            <option value="">Click "Load Events" to see available events</option>
                        </select>
                    </div>
                    <button class="action-btn" id="loadEvents">
                        ðŸ“‹ Load Events
                    </button>
                    <button class="action-btn" id="setEvent">
                        âœ“ Set Event
                    </button>
                </div>

                <div class="current-event" id="currentEvent">
                    Current: Loading...
                </div>
            </div>

            <div class="control-section">
                <h2>Data Management</h2>
                <button class="action-btn" id="refreshRankings">
                    ðŸ”„ Refresh Rankings Data
                </button>
                <p class="description" style="margin-top: 10px;">
                    <small>Manually refresh rankings from FLL Nexus. Rankings are also updated automatically when you set an event.</small>
                </p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRegion = 'socal';
        let currentEventId = 'demo';
        let availableEvents = {};

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').classList.add('connected');

            // Request current event info on connect
            socket.emit('request_event_info');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').classList.remove('connected');
        });

        // Handle event info updates
        socket.on('event_info', (data) => {
            console.log('Received event info:', data);
            if (data.region && data.event_id) {
                currentRegion = data.region;
                currentEventId = data.event_id;

                // Update region field
                document.getElementById('regionSelect').value = data.region;

                // Update current event display
                const eventName = data.event_name || data.event_id;
                document.getElementById('currentEvent').textContent = `Current: ${data.region}/${eventName}`;
            }
        });

        // Load events
        document.getElementById('loadEvents').addEventListener('click', () => {
            const region = document.getElementById('regionSelect').value.trim();
            if (!region) {
                alert('Please enter a region');
                return;
            }

            const btn = document.getElementById('loadEvents');
            btn.textContent = 'â³ Loading...';
            btn.disabled = true;

            socket.emit('load_events', { region: region });
        });

        socket.on('events_list', (data) => {
            const btn = document.getElementById('loadEvents');
            btn.textContent = 'ðŸ“‹ Load Events';
            btn.disabled = false;

            if (data.error) {
                alert('Error loading events: ' + data.error);
                return;
            }

            availableEvents = data.events;
            const select = document.getElementById('eventSelect');
            select.innerHTML = '';

            if (Object.keys(availableEvents).length === 0) {
                select.innerHTML = '<option value="">No events found</option>';
                return;
            }

            let index = 1;
            for (const [eventId, eventData] of Object.entries(availableEvents)) {
                const option = document.createElement('option');
                option.value = eventId;
                const eventName = eventData.name || eventId;
                option.textContent = `${index}. ${eventId} - ${eventName}`;
                select.appendChild(option);
                index++;
            }
        });

        // Set event
        document.getElementById('setEvent').addEventListener('click', () => {
            const region = document.getElementById('regionSelect').value.trim();
            const eventId = document.getElementById('eventSelect').value;

            if (!region || !eventId) {
                alert('Please select a region and event');
                return;
            }

            currentRegion = region;
            currentEventId = eventId;

            socket.emit('set_event', {
                region: region,
                event_id: eventId
            });

            // Find event name from availableEvents
            const eventName = (availableEvents[eventId] && availableEvents[eventId].name) || eventId;
            document.getElementById('currentEvent').textContent = `Current: ${region}/${eventName}`;

            // Auto-refresh rankings
            setTimeout(() => {
                socket.emit('request_rankings');
            }, 500);

            // Show success message
            alert('Event set successfully! Rankings are being refreshed.');
        });

        // Refresh rankings
        document.getElementById('refreshRankings').addEventListener('click', () => {
            socket.emit('request_rankings');
            const btn = document.getElementById('refreshRankings');
            btn.textContent = 'â³ Refreshing...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = 'ðŸ”„ Refresh Rankings Data';
                btn.disabled = false;
            }, 2000);
        });
    </script>
</body>
</html>
