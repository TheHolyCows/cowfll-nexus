<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/controller.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Branded Banner -->
        <div class="brand-banner">
            <img src="{{ url_for('static', filename='images/flltm.svg') }}" alt="FLL TM Logo" class="brand-logo">
            <div class="brand-text">
                <div class="brand-title">FLL Nexus</div>
                <div class="brand-subtitle">Tournament Management System</div>
            </div>
        </div>

        <header>
            <h1>Event Setup</h1>
            <div class="status" id="connectionStatus">Disconnected</div>
        </header>

        <div class="controls">
            <div class="control-section">
                <a href="/controller" class="nav-link" style="text-decoration: none; display: inline-block; margin-bottom: 20px;">
                    <button class="back-btn" style="background: linear-gradient(135deg, #00AEEF 0%, #0088CC 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;">‚Üê Back to Controller</button>
                </a>
            </div>

            <div class="control-section">
                <h2>Authentication Status</h2>
                <p class="description">Manage your FLL Nexus authentication</p>

                <div id="authStatusSection">
                    <div class="current-event" id="authStatus" style="background: #f9f9f9; color: #535353;">
                        Checking authentication...
                    </div>

                    <div id="authButtons" style="margin-top: 15px; display: none; text-align: center;">
                        <a href="/auth" id="authLink" style="text-decoration: none; display: inline-block; margin-right: 10px;">
                            <button class="action-btn" id="authBtn" style="width: auto; display: inline-block;">
                                üîê Authenticate
                            </button>
                        </a>
                        <button class="action-btn" id="logoutBtn" style="width: auto; display: inline-block; background: linear-gradient(135deg, #EE3123 0%, #CC291F 100%); display: none;">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h2>Event Selection</h2>
                <p class="description">Select which FLL event to display rankings and information for</p>

                <div class="event-selector">
                    <div class="form-group">
                        <label for="regionSelect">Region:</label>
                        <input type="text" id="regionSelect" value="socal" placeholder="e.g., socal, norcal, socal2">
                    </div>
                    <div class="form-group">
                        <label for="eventSelect">Event:</label>
                        <select id="eventSelect">
                            <option value="">Click "Load Events" to see available events</option>
                        </select>
                    </div>
                    <button class="action-btn" id="loadEvents">
                        üìã Load Events
                    </button>
                    <button class="action-btn" id="setEvent">
                        ‚úì Set Event
                    </button>
                </div>

                <div class="current-event" id="currentEvent">
                    Current: Loading...
                </div>
            </div>

            <div class="control-section">
                <h2>Data Management</h2>
                <button class="action-btn" id="refreshRankings">
                    üîÑ Refresh Rankings Data
                </button>
                <p class="description" style="margin-top: 10px;">
                    <small>Manually refresh rankings from FLL Nexus. Rankings are also updated automatically when you set an event.</small>
                </p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRegion = 'socal';
        let currentEventId = 'demo';
        let availableEvents = {};
        let tokenExpiryTimestamp = null;
        let expiryUpdateInterval = null;

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').classList.add('connected');

            // Request current event info and user info on connect
            socket.emit('request_event_info');
            socket.emit('request_user_info');
        });

        // Authentication status (no redirect needed - app still works without auth)
        socket.on('auth_status', (data) => {
            if (!data.authenticated) {
                console.log('Not authenticated - live data fetching may fail');
            } else {
                console.log('Authenticated - can fetch live data');
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').classList.remove('connected');
        });

        // Handle event info updates
        socket.on('event_info', (data) => {
            console.log('Received event info:', data);
            if (data.region && data.event_id) {
                currentRegion = data.region;
                currentEventId = data.event_id;

                // Update region field
                document.getElementById('regionSelect').value = data.region;

                // Update current event display
                const eventName = data.event_name || data.event_id;
                document.getElementById('currentEvent').textContent = `Current: ${data.region}/${eventName}`;
            }
        });

        // Load events
        document.getElementById('loadEvents').addEventListener('click', () => {
            const region = document.getElementById('regionSelect').value.trim();
            if (!region) {
                alert('Please enter a region');
                return;
            }

            const btn = document.getElementById('loadEvents');
            btn.textContent = '‚è≥ Loading...';
            btn.disabled = true;

            socket.emit('load_events', { region: region });
        });

        socket.on('events_list', (data) => {
            const btn = document.getElementById('loadEvents');
            btn.textContent = 'üìã Load Events';
            btn.disabled = false;

            if (data.error) {
                alert('Error loading events: ' + data.error);
                return;
            }

            availableEvents = data.events;
            const select = document.getElementById('eventSelect');
            select.innerHTML = '';

            if (Object.keys(availableEvents).length === 0) {
                select.innerHTML = '<option value="">No events found</option>';
                return;
            }

            let index = 1;
            for (const [eventId, eventData] of Object.entries(availableEvents)) {
                const option = document.createElement('option');
                option.value = eventId;
                const eventName = eventData.name || eventId;
                option.textContent = `${index}. ${eventId} - ${eventName}`;
                select.appendChild(option);
                index++;
            }
        });

        // Set event
        document.getElementById('setEvent').addEventListener('click', () => {
            const region = document.getElementById('regionSelect').value.trim();
            const eventId = document.getElementById('eventSelect').value;

            if (!region || !eventId) {
                alert('Please select a region and event');
                return;
            }

            currentRegion = region;
            currentEventId = eventId;

            socket.emit('set_event', {
                region: region,
                event_id: eventId
            });

            // Find event name from availableEvents
            const eventName = (availableEvents[eventId] && availableEvents[eventId].name) || eventId;
            document.getElementById('currentEvent').textContent = `Current: ${region}/${eventName}`;

            // Auto-refresh rankings
            setTimeout(() => {
                socket.emit('request_rankings');
            }, 500);

            // Show success message
            alert('Event set successfully! Rankings are being refreshed.');
        });

        // Refresh rankings
        document.getElementById('refreshRankings').addEventListener('click', () => {
            socket.emit('request_rankings');
            const btn = document.getElementById('refreshRankings');
            btn.textContent = '‚è≥ Refreshing...';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = 'üîÑ Refresh Rankings Data';
                btn.disabled = false;
            }, 2000);
        });

        // Format token expiry time
        function formatTokenExpiry(expiryTimestamp) {
            if (!expiryTimestamp) return '';

            const expiryDate = new Date(expiryTimestamp * 1000); // Convert Unix timestamp to milliseconds
            const now = new Date();
            const timeUntilExpiry = expiryDate - now;

            // Calculate time remaining
            const minutesRemaining = Math.floor(timeUntilExpiry / 60000);
            const hoursRemaining = Math.floor(minutesRemaining / 60);
            const minsRemainder = minutesRemaining % 60;

            // Format the expiry date/time
            const timeString = expiryDate.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            // Build time remaining string
            let remainingStr = '';
            if (timeUntilExpiry > 0) {
                if (hoursRemaining > 0) {
                    remainingStr = ` (expires in ${hoursRemaining}h ${minsRemainder}m)`;
                } else {
                    remainingStr = ` (expires in ${minutesRemaining}m)`;
                }
            } else {
                remainingStr = ' (expired - will refresh on next request)';
            }

            return `Token expires: ${timeString}${remainingStr}`;
        }

        // Update token expiry display
        function updateTokenExpiryDisplay() {
            if (!tokenExpiryTimestamp) return;

            const authStatus = document.getElementById('authStatus');
            const email = authStatus.getAttribute('data-email');

            if (email) {
                const expiryInfo = formatTokenExpiry(tokenExpiryTimestamp);
                authStatus.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">Authenticated as: ${email}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${expiryInfo}</div>
                `;
            }
        }

        // Handle user info response
        socket.on('user_info', (data) => {
            const authStatus = document.getElementById('authStatus');
            const authButtons = document.getElementById('authButtons');
            const authBtn = document.getElementById('authBtn');
            const authLink = document.getElementById('authLink');
            const logoutBtn = document.getElementById('logoutBtn');

            authButtons.style.display = 'block';

            if (data.authenticated && data.email) {
                tokenExpiryTimestamp = data.token_expiry;
                authStatus.setAttribute('data-email', data.email);

                const expiryInfo = formatTokenExpiry(data.token_expiry);
                authStatus.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">Authenticated as: ${data.email}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${expiryInfo}</div>
                `;
                authStatus.style.background = '#f0f9ff';
                authStatus.style.color = '#00AEEF';

                // Disable authenticate button when logged in
                authBtn.disabled = true;
                authLink.style.pointerEvents = 'none';
                authLink.style.cursor = 'not-allowed';

                logoutBtn.style.display = 'inline-block';

                // Start updating the expiry display every minute
                if (expiryUpdateInterval) {
                    clearInterval(expiryUpdateInterval);
                }
                expiryUpdateInterval = setInterval(updateTokenExpiryDisplay, 60000); // Update every minute
            } else {
                tokenExpiryTimestamp = null;
                authStatus.removeAttribute('data-email');
                authStatus.textContent = 'Not authenticated';
                authStatus.style.background = '#fff3cd';
                authStatus.style.color = '#856404';

                // Enable authenticate button when not logged in
                authBtn.disabled = false;
                authLink.style.pointerEvents = 'auto';
                authLink.style.cursor = 'pointer';

                logoutBtn.style.display = 'none';

                // Stop updating expiry display
                if (expiryUpdateInterval) {
                    clearInterval(expiryUpdateInterval);
                    expiryUpdateInterval = null;
                }
            }
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout? You will need to re-authenticate to fetch live data.')) {
                socket.emit('logout');
            }
        });

        // Handle logout success
        socket.on('logout_success', (data) => {
            console.log('Logged out successfully');
            // Refresh user info display
            socket.emit('request_user_info');
        });
    </script>
</body>
</html>
